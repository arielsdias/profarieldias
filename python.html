<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Curso Python</title>

<!-- TAILWIND -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- LUCIDE ICONS -->
<script src="https://unpkg.com/lucide@latest"></script>

<!-- MONACO EDITOR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>

<!-- PYODIDE -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.26.0/full/pyodide.js"></script>

<style>
    .sidebar-open { width: 320px; }
    .sidebar-closed { width: 0px; }

    @keyframes loader-bar {
        0% { transform: translateX(-100%); }
        50% { transform: translateX(-10%); }
        100% { transform: translateX(100%); }
    }
    .animate-loader-bar { animation: loader-bar 1.5s infinite; }
</style>
</head>

<body class="h-screen bg-gradient-to-br from-slate-50 to-slate-100 overflow-hidden">

<!-- LOADING -->
<div id="globalLoader"
     class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-slate-950/90 text-white transition-opacity duration-500">
  <div class="mb-4 text-2xl font-semibold flex items-center gap-3">
    <span class="inline-flex h-10 w-10 rounded-full border-4 border-emerald-400 border-t-transparent animate-spin"></span>
    <span>Carregando ambiente de estudo...</span>
  </div>
  <div class="w-64 h-2 bg-slate-800 rounded-full overflow-hidden">
    <div class="h-full bg-gradient-to-r from-emerald-400 via-sky-400 to-indigo-400 animate-loader-bar"></div>
  </div>
  <p class="mt-4 text-sm text-slate-300">Preparando editor, v√≠deos e exerc√≠cios interativos</p>
</div>

<div class="flex h-full">

<!-- SIDEBAR -->
<aside id="sidebar" class="sidebar-open transition-all duration-300 bg-white shadow-2xl overflow-hidden">

    <div class="p-6 bg-gradient-to-r from-blue-600 to-indigo-700 text-white">
        <h1 class="text-2xl font-bold mb-1">Curso Python</h1>
        <p class="text-sm text-blue-100 mb-4">Do zero ao avan√ßado</p>

        <div class="bg-white/20 rounded-lg p-3">
            <div class="flex justify-between text-sm mb-2">
                <span class="font-medium">Seu Progresso</span>
                <span id="progressText">0%</span>
            </div>

            <div class="w-full bg-white/30 rounded-full h-2.5">
                <div id="progressBar"
                     class="bg-yellow-400 h-2.5 rounded-full transition-all duration-500"
                     style="width: 0%"></div>
            </div>

            <div id="progressCount" class="mt-2 text-xs text-blue-100">0 de 0 t√≥picos</div>
        </div>
    </div>

    <div id="modulesList" class="overflow-y-auto h-[calc(100vh-220px)]"></div>

</aside>

<!-- MAIN CONTENT -->
<main class="flex-1 flex flex-col overflow-hidden">

    <header class="bg-white shadow-md px-6 py-4 flex items-center gap-4">
        <button id="toggleSidebar" class="p-2 hover:bg-slate-100 rounded-lg">
            <i data-lucide="menu"></i>
        </button>

        <div class="flex-1">
            <h2 id="topicTitle" class="text-xl font-bold text-slate-800">Selecione um t√≥pico</h2>
            <p id="topicType" class="text-sm text-slate-500"></p>
        </div>

        <button id="markCompleteBtn"
            class="hidden px-6 py-2.5 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 flex items-center gap-2 text-sm font-semibold">
            <i data-lucide="check-circle" class="w-4 h-4"></i>
            Concluir T√≥pico
        </button>
    </header>

    <section id="contentArea" class="flex-1 overflow-y-auto p-6">
        <p class="text-slate-600">Selecione um t√≥pico √† esquerda para come√ßar.</p>
    </section>

</main>
</div>


<script>
/* =======================
   JSON DO CURSO (OK)
======================= */
const courseData = {
    modules: [
        {
            title: "M√≥dulo 1: No√ß√µes B√°sicas de Python",
            topics: [
                { 
                    id: "1.1",
                    type: "theory",
                    title: "Introdu√ß√£o ao Python e Print",
                    gamma: "https://introducao-python-hydl3k5.gamma.site/",
                    video: "https://player.vimeo.com/video/123456789"
                }
                ,

                { 
                    id: "1.2",
                    type: "practice",
                    title: "Pr√°tica: Ol√°, Mundo!",
                    problemStatement:
`Aqui come√ßa o caminho do verdadeiro desenvolvedor!

- Crie um programa que exiba exatamente:
Ol√°, Mundo!

üí° Dica: Digite
print("Ol√°, mundo!")

ap√≥s digitar o c√≥digo, pressione o bot√£o Executar C√≥digo.`,
                    respostaEsperada: "Ol√°, Mundo!"
                }
                ,

                { 
                    id: "1.3",
                    type: "practice",
                    title: "Pr√°tica: Primeiro c√≥digo Python!",
                    problemStatement:
`√â hora de rodar seu primeiro c√≥digo Python!

Digite:
print(5 + 2)

Clique no bot√£o ‚ÄúExecutar C√≥digo‚Äù para ver o resultado.`,
                    respostaEsperada: "7"
                }
                ,

                { 
                    id: "1.4",
                    type: "practice",
                    title: "Pr√°tica: Comentando c√≥digo.",
                    problemStatement:
`Observe o c√≥digo que j√° foi carregado no editor. Comente todas as linhas, utilize o coment√°rio que for melhor!
Por fim, clique no bot√£o ‚ÄúExecutar C√≥digo‚Äù para ver o resultado.`,
                    respostaEsperada: "Sou programador!!",
                    codigoPreEscrito: `print("comente com hashtag")
print("Sou programador!!")
print("comente essa linha com aspas triplas")
print("comente essa linha com aspas triplas")
`
                }
                ,

                { 
                    id: "1.5",
                    type: "practice",
                    title: "Pr√°tica: Atribui√ß√£o de vari√°veis.",
                    problemStatement:
`
Em Python, uma vari√°vel permite que voc√™ fa√ßa refer√™ncia a um valor com um nome. 
Para criar uma vari√°vel x com valor 5, usamos =, como neste exemplo:\n
x=5
\n
Agora voc√™ pode usar o nome dessa vari√°vel, x, em vez do valor real, 5.
\n
Lembre-se de que = em Python significa atribui√ß√£o, ele n√£o testa a igualdade! 
Fa√ßa o teste no exerc√≠cio ao lado substituindo ____ pelo seu c√≥digo.

\n

Crie uma vari√°vel chamada ano com valor 2026.
Verifique essa vari√°vel digitando print(ano) no c√≥digo.



`,
                    respostaEsperada: "2026",
                    codigoPreEscrito: `# Crie a vari√°vel chamada ano
____

# Print o ano na tela.
____
`
                }
            ]
        }
    ]
};

const STORAGE_KEY = "curso_python_estado_v1";

let selectedTopic = null;
let completed = new Set();
let practiceCode = {};

let pyodidePractice = null;
let editorPractice = null;


/* =======================
   LOCALSTORAGE
======================= */
function loadState() {
    try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;

        const data = JSON.parse(raw);
        if (Array.isArray(data.completed)) completed = new Set(data.completed);
        if (data.practiceCode) practiceCode = data.practiceCode;
        return data;

    } catch { return null; }
}

function saveState() {
    const state = {
        completed: [...completed],
        lastTopicId: selectedTopic?.id || null,
        practiceCode
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}


/* =======================
   SIDEBAR
======================= */
function renderSidebar() {
    const modulesList = document.getElementById("modulesList");
    modulesList.innerHTML = "";

    courseData.modules.forEach(mod => {
        const moduleDiv = document.createElement("div");
        moduleDiv.innerHTML = `<div class="p-4 bg-slate-100 font-semibold border-b">${mod.title}</div>`;

        mod.topics.forEach(topic => {
            const isDone = completed.has(topic.id);

            const topicDiv = document.createElement("div");
            topicDiv.className =
                "p-3 pl-6 flex gap-3 items-center cursor-pointer transition hover:bg-slate-50";

            topicDiv.innerHTML = `
                <i data-lucide="${isDone ? "check-circle" : ""}" 
                   class="w-5 h-5 ${isDone ? "text-green-600" : ""}"></i>

                <i data-lucide="${topic.type === "theory" ? "book-open" : "code"}"
                   class="w-4 h-4"></i>

                <span>${topic.title}</span>
            `;

            topicDiv.onclick = () => {
                loadTopic(topic);
                renderSidebar();
            };

            moduleDiv.appendChild(topicDiv);
        });

        modulesList.appendChild(moduleDiv);
    });

    lucide.createIcons();
}


/* =======================
   ABAS (TEORIA)
======================= */
function loadTheory(topic) {

    document.getElementById("contentArea").innerHTML = `
        <div class="border-b border-slate-300 mb-4 flex gap-2">
            <button id="tabVideo"
                class="px-4 py-2 text-sm font-semibold text-blue-600 border-b-2 border-blue-600">
                V√≠deo da Aula
            </button>

            <button id="tabGamma"
                class="px-4 py-2 text-sm font-semibold text-slate-500 hover:text-blue-600">
                Material Interativo
            </button>
        </div>

        <div id="contentVideo">
            <iframe src="${topic.video}"
                class="w-full h-[600px] rounded-xl shadow border"
                frameborder="0"></iframe>
        </div>

        <div id="contentGamma" class="hidden">
            <iframe src="${topic.gamma}"
                class="w-full h-[600px] rounded-xl shadow border"
                frameborder="0"></iframe>
        </div>
    `;

    const tabVideo = document.getElementById("tabVideo");
    const tabGamma = document.getElementById("tabGamma");

    const contentVideo = document.getElementById("contentVideo");
    const contentGamma = document.getElementById("contentGamma");

    tabVideo.onclick = () => {
        tabVideo.classList.add("text-blue-600", "border-blue-600");
        tabGamma.classList.remove("text-blue-600", "border-blue-600");

        contentVideo.classList.remove("hidden");
        contentGamma.classList.add("hidden");
    };

    tabGamma.onclick = () => {
        tabGamma.classList.add("text-blue-600", "border-blue-600");
        tabVideo.classList.remove("text-blue-600", "border-blue-600");

        contentGamma.classList.remove("hidden");
        contentVideo.classList.add("hidden");
    };
}


/* =======================
   RENDER EXERC√çCIO
======================= */
function renderExercise(topic) {

    document.getElementById("contentArea").innerHTML = `
        <div class="flex gap-4 h-[380px]">

            <div id="exercise"
                 class="w-[45%] bg-white border border-slate-300 rounded-xl p-5 shadow-sm overflow-auto">
                <div class="flex items-center gap-2 mb-3">
                    <i data-lucide="list-checks" class="w-5 h-5 text-slate-700"></i>
                    <h2 class="text-lg font-bold text-slate-800">Exerc√≠cio</h2>
                </div>

                <div id="exerciseContent" class="text-slate-700 leading-relaxed text-[15px]"></div>

                <div class="mt-4 bg-slate-100 border border-slate-300 rounded-md p-3">
                    <p class="font-semibold text-sm text-slate-800 mb-1">Resultado esperado:</p>
                    <pre id="expectedOutput" class="text-slate-900 whitespace-pre-wrap"></pre>
                </div>
            </div>

            <div id="editor"
                 class="w-[55%] bg-[#1e1e1e] border border-slate-300 rounded-xl"></div>
        </div>

        <button id="run"
            class="mt-5 px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 text-sm font-semibold">
            Executar C√≥digo
        </button>

        <h3 class="mt-4 font-semibold text-slate-800">Sa√≠da:</h3>

        <div id="output"
             class="mt-2 p-3 bg-[#272822] text-white rounded-md min-h-[120px] whitespace-pre-wrap">
             Inicializando interpretador Python...
        </div>
    `;

    renderExerciseBox(topic);
}


/* =======================
   FORMATADOR DE EXERC√çCIO
======================= */
function renderExerciseBox(topic) {

    const raw = topic.problemStatement;
    let html = "";

    raw.split("\n").forEach(line => {

        if (line.trim().startsWith("- ")) {
            html += `<li class="ml-6 list-disc">${line.replace("- ", "")}</li>`;
        }

        else if (line.trim().startsWith("print") || line.includes("(")) {
            html += `<pre class="bg-slate-900 text-slate-100 p-2 rounded-md my-2">${line}</pre>`;
        }

        else if (line.trim() === "") {
            html += `<div class="my-2"></div>`;
        }

        else {
            html += `<p>${line}</p>`;
        }
    });

    document.getElementById("exerciseContent").innerHTML = html;
    document.getElementById("expectedOutput").innerText = topic.respostaEsperada;
}


/* =======================
   TOPIC LOADER
======================= */
function loadTopic(topic) {

    selectedTopic = topic;

    document.getElementById("topicTitle").textContent = topic.title;
    document.getElementById("topicType").textContent =
        topic.type === "theory" ? "üìñ Conte√∫do Te√≥rico" : "üíª Exerc√≠cio Pr√°tico";

    document.getElementById("markCompleteBtn").classList.remove("hidden");

    if (topic.type === "theory") loadTheory(topic);
    else renderExercise(topic);

    updateProgress();
    saveState();

    if (topic.type === "practice") {
        initMonacoPracticeEditor();
        loadPyodideForPractice();
    }
}


/* =======================
   MONACO EDITOR
======================= */
function initMonacoPracticeEditor() {

    require.config({
        paths: { vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs" }
    });

    require(["vs/editor/editor.main"], function () {

        const topicId = selectedTopic.id;

        // 1Ô∏è‚É£ Prioridade: c√≥digo salvo anteriormente
        if (practiceCode[topicId]) {
            initialValue = practiceCode[topicId];
        }

        // 2Ô∏è‚É£ Caso n√£o exista salvo, usa codigoPreEscrito (se existir)
        else if (selectedTopic.codigoPreEscrito) {
            initialValue = selectedTopic.codigoPreEscrito;
        }

        // 3Ô∏è‚É£ Padr√£o
        else {
            initialValue = "# Escreva seu c√≥digo Python aqui\n";
        }

        editorPractice = monaco.editor.create(
            document.getElementById("editor"),
            {
                value: initialValue,
                language: "python",
                theme: "vs-dark",
                automaticLayout: true
            }
        );

        // Salva mudan√ßas automaticamente
        editorPractice.onDidChangeModelContent(() => {
            practiceCode[topicId] = editorPractice.getValue();
            saveState();
        });

    });
}



/* =======================
   PYODIDE
======================= */
async function loadPyodideForPractice() {

    const out = document.getElementById("output");

    if (!pyodidePractice) {
        out.innerText = "Carregando engine Python...";
        pyodidePractice = await loadPyodide({
            indexURL: "https://cdn.jsdelivr.net/pyodide/v0.26.0/full/"
        });
    }

    out.innerText = "Python carregado!";

    document.getElementById("run").onclick = () => runStudentCode();
}


/* =======================
   EXECUTAR C√ìDIGO
======================= */
async function runStudentCode() {

    const code = editorPractice.getValue();
    const out = document.getElementById("output");

    out.innerText = "Executando c√≥digo...\n";

    try {
        const wrapped = `
import sys
from io import StringIO
buf = StringIO()
old = sys.stdout
sys.stdout = buf
${code}
sys.stdout = old
buf.getvalue()
`;

        let result = await pyodidePractice.runPythonAsync(wrapped);
        out.innerText = result || "(sem sa√≠da)";
        validatePractice(result || "");

    } catch (err) {
        out.innerText = "Erro:\n" + err;
    }
}


/* =======================
   SIMILARIDADE
======================= */
function similarity(a, b) {
    a = a.trim().toLowerCase();
    b = b.trim().toLowerCase();
    const len = Math.max(a.length, b.length);
    let match = 0;
    for (let i = 0; i < Math.min(a.length, b.length); i++)
        if (a[i] === b[i]) match++;
    return (match / len) * 100;
}


/* =======================
   VALIDA√á√ÉO
======================= */
function validatePractice(output) {

    const expected = selectedTopic.respostaEsperada;
    const pct = similarity(output, expected);

    const box = document.getElementById("output");

    if (pct >= 80)
        box.innerText += `\n\n‚úî Similaridade ${pct.toFixed(1)}% ‚Äî Solu√ß√£o aceita!`;
    else
        box.innerText += `\n\n‚úò Similaridade ${pct.toFixed(1)}%. Ajuste o c√≥digo.`;
}


/* =======================
   PROGRESSO
======================= */
function updateProgress() {
    const total = courseData.modules.reduce((acc, m) => acc + m.topics.length, 0);
    const pct = Math.round((completed.size / total) * 100);

    document.getElementById("progressText").innerText = pct + "%";
    document.getElementById("progressBar").style.width = pct + "%";
    document.getElementById("progressCount").innerText = 
        `${completed.size} de ${total} t√≥picos`;
}


/* =======================
   CONCLUIR T√ìPICO
======================= */
document.getElementById("markCompleteBtn").onclick = () => {
    if (!selectedTopic) return;
    completed.add(selectedTopic.id);
    saveState();
    updateProgress();
    renderSidebar();
};


/* =======================
   INICIALIZA√á√ÉO
======================= */
const saved = loadState();
renderSidebar();
updateProgress();

if (saved?.lastTopicId) {
    const topic = courseData.modules
        .flatMap(m => m.topics)
        .find(t => t.id === saved.lastTopicId);
    if (topic) loadTopic(topic);
}

window.addEventListener("load", () => {
    const gl = document.getElementById("globalLoader");
    gl.classList.add("opacity-0", "pointer-events-none");
    setTimeout(() => gl.style.display = "none", 200);
});

lucide.createIcons();
</script>

</body>
</html>
